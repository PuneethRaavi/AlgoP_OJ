{% extends 'base.html' %}
{% load static %}
{% load markdown %}

{% block title %}{{ problem.title }} - OnlineJudge{% endblock %}

{% block head_extra %}
<!-- Compiler CSS -->
<link rel="stylesheet" href="{% static 'css/judge.css' %}">
<!-- CodeMirror CSS Files -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/eclipse.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/cobalt.min.css" />
<!-- Custom styles for CodeMirror height -->
<style>
    .CodeMirror {
        border: 1px solid #d1d5db; /* light mode border */
        border-radius: 0.375rem;
        height: 100%; 
        min-height: 450px;
    }
    .dark .CodeMirror {
        border-color: #4b5563; /* dark mode border */
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto p-4 lg:p-6 -mt-12">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Left Panel: Code Runner -->
        <div class="code-panel bg-white dark:bg-gray-800/50 dark:backdrop-blur-lg rounded-xl shadow-md border border-gray-200 dark:border-gray-700 flex flex-col">
            <form id="code-form" method="post" novalidate class="flex flex-col flex-grow p-6">
                {% csrf_token %}
                
                <!-- Sticky Header: Language and Theme Selectors -->
                <div class="sticky top-0 -mx-6 -mt-6 mb-4 px-6 pt-4 pb-3 bg-stone-100/50 dark:bg-slate-950/30 backdrop-blur-sm z-10 border-b border-gray-200 dark:border-gray-700 relative">
                    <div class="flex flex-wrap gap-x-8 gap-y-2 -mt-1 items-center">
                        <div class="flex items-center gap-3">
                            <label for="{{ form.language.id_for_label }}" class="block text-[11px] font-medium text-gray-600 dark:text-gray-300">Language</label>
                            {{ form.language }}
                        </div>
                        <div class="flex items-center gap-3">
                            <label for="{{ form.theme.id_for_label }}" class="block text-[11px] font-medium text-gray-600 dark:text-gray-300">{{ form.theme.label }}</label>
                            {{ form.theme }}
                        </div>
                    </div>
                    <!-- Font size selector positioned at the top right -->
                    <div class="absolute top-2 right-6 mb-5 -mr-4">
                        {{ form.fontSize }}
                    </div>
                </div>
                
                <!-- CodeMirror Editor: Removed the hardcoded text size class -->
                <div class="flex-grow">
                    {{ form.code }}
                </div>
                
                <hr class="my-4 border-gray-200 dark:border-gray-700"> 

                <!-- Input -->
                <div class="-mb-3.5">
                    {{ form.input }}
                </div>

            </form>
        </div>
        
        <!-- Right Column: Combines Problem and Output -->
        <div class="right-column-wrapper flex flex-col gap-6">
            <!-- Problem Description Panel -->
            <div class="problem-panel h-[65%] bg-white dark:bg-gray-800/50 dark:backdrop-blur-lg rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">{{ problem.title }}</h2>
                    <span class="difficulty-badge difficulty-{{ problem.difficulty }}">{{ problem.difficulty }}</span>
                </div>
                <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Time Limit: {{ problem.time_limit }}s | Memory Limit: {{ problem.memory_limit }}MB</p>
                <hr class="my-4 border-gray-200 dark:border-gray-700">
                <div class="prose prose-sm dark:prose-invert max-w-none text-[12px]">
                    {{ problem.description|markdown }}
                </div>

                {% if sample_tests %}
                <div class="mt-6">
                    <h3 class="text-base font-semibold mb-2 text-gray-900 dark:text-white">Sample Testcases</h3>
                    {% for test in sample_tests %}
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-1">
                            <strong class="text-[11px] font-medium text-gray-800 dark:text-gray-300">Input:</strong>
                            <button type="button" class="text-[11px] text-sky-500 hover:text-sky-600 dark:text-sky-600 dark:hover:text-sky-400 font-semibold transition-colors" onclick="copyToClipboard('input-{{ forloop.counter }}')">Copy</button>
                        </div>
                        <pre id="input-{{ forloop.counter }}" class="bg-gray-100 dark:bg-slate-900 p-3 rounded-md text-[11px] text-gray-700 dark:text-gray-300">{{ test.input }}</pre>
                        <strong class="block mt-3 text-[11px] font-medium text-gray-800 dark:text-gray-300">Expected Output:</strong>
                        <pre class="bg-gray-100 dark:bg-slate-900 p-3 rounded-md text-[11px] text-gray-700 dark:text-gray-300">{{ test.expected_output }}</pre>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Results Panel -->
            <div class="output-panel flex-grow flex flex-col bg-white dark:bg-gray-800/50 dark:backdrop-blur-lg rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                
                <!-- 1. Fixed "Verdict" Header -->
                <div class="sticky top-0 -mx-6 -mt-6 mb-4 px-6 pt-3 pb-2 bg-stone-100/50 dark:bg-slate-950/30 backdrop-blur-sm z-10 border-b border-gray-200 dark:border-gray-700 relative">
                    <div class="flex items-center gap-3">
                        <!-- Status -->
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-300 ml-6">Verdict:</span>
                        <span class="rounded-md text-[15px]
                            {% if status == 'Accepted' %} text-green-800 dark:text-green-300
                            {% elif status == 'Pending' or status == 'Running' %} text-yellow-800 dark:text-yellow-300
                            {% elif not status %} text-amber-700 dark:text-amber-200
                            {% else %} text-red-800 dark:text-red-300 {% endif %}">
                            {{ status|default:"No submission yet" }}
                        </span>

                        <!-- Spacer to push buttons to the right -->
                        <div class="ml-auto flex items-center gap-2">
                            {% if submission and submission.status != 'Accepted' %}
                            <a href="{% url 'ai_review' submission.id %}" 
                               target="_blank" rel="noopener noreferrer"
                               class="mr-2 text-xs py-1 px-3 border border-transparent rounded-md shadow-sm font-medium text-white bg-blue-600 hover:bg-blue-700 dark:bg-indigo-500 dark:hover:bg-sky-600">
                                AI Review âœ¨
                            </a>
                            {% endif %}
                            <!-- Run Button -->
                            <button type="submit" form="code-form" name="action" value="run" class="mr-1 text-xs py-1 px-3 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-emerald-600 hover:bg-emerald-700 dark:text-gray-300 dark:bg-cyan-700 dark:hover:bg-cyan-400">Run</button>
                            <!-- Submit Button -->
                            <button type="submit" form="code-form" name="action" value="submit" class="mr-4 text-xs py-1 px-1 border border-transparent rounded-md shadow-xs text-xs font-medium text-white bg-red-600 hover:bg-red-700 dark:text-gray-300 dark:bg-rose-800 dark:hover:bg-rose-400">Submit</button>
                        </div>
                    </div>
                </div>

                <!-- 2. Growing Output Box -->
                <div class="flex-grow p-4 -mb-1">
                    <pre class="bg-gray-900 dark:bg-zinc-950 text-white p-3 rounded-md text-[12px] h-full w-full overflow-auto"><code>{{ output }}</code></pre>
                </div>

            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- CodeMirror Core JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<!-- CodeMirror Addons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>
<!-- Language Modes for Syntax Highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<!-- Compiler JS -->
<script src="{% static 'js/judge.js' %}"></script>
{% endblock %}
